<script>
	import { page } from '$app/stores';
	import { afterNavigate } from '$app/navigation';

	// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®å‡¦ç†
	afterNavigate(() => {
		// ãƒ¢ãƒã‚¤ãƒ«ã§ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
		if (window.innerWidth < 1024) {
			const event = new CustomEvent('closeSidebar');
			window.dispatchEvent(event);
		}
	});

	// ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹é€ ã®å®šç¾©
	const menuItems = [
		{
			title: 'ã¯ã˜ã‚ã«',
			icon: 'ğŸ“–',
			color: 'text-purple-500',
			items: [
				{ title: 'ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦', href: '/intro' },
				{ title: 'è‘—è€…ã«ã¤ã„ã¦', href: '/profile' }
			]
		},
		{
			title: 'HTML',
			icon: 'ğŸŒ',
			color: 'text-orange-500',
			items: [
				{ title: 'åŸºæœ¬æ§‹é€ ', href: '/html/basics' },
				{ title: 'è¦ç´ ã¨ã‚¿ã‚°', href: '/html/elements' },
				{ title: 'ãƒ•ã‚©ãƒ¼ãƒ ', href: '/html/forms' },
				{ title: 'ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹', href: '/html/semantics' }
			]
		},
		{
			title: 'CSS',
			icon: 'ğŸ¨',
			color: 'text-blue-500',
			items: [
				{ title: 'ã‚»ãƒ¬ã‚¯ã‚¿', href: '/css/selectors' },
				{ title: 'ãƒœãƒƒã‚¯ã‚¹ãƒ¢ãƒ‡ãƒ«', href: '/css/box-model' },
				{ title: 'Flexbox', href: '/css/flexbox' },
				{ title: 'Grid', href: '/css/grid' }
			]
		},
		{
			title: 'JavaScript',
			icon: 'âš¡',
			color: 'text-yellow-500',
			items: [
				{ title: 'å¤‰æ•°ã¨å‹', href: '/js/variables' },
				{ title: 'é–¢æ•°', href: '/js/functions' },
				{ title: 'é…åˆ—ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ', href: '/js/arrays-objects' },
				{ title: 'éåŒæœŸå‡¦ç†', href: '/js/async' },
				{ title: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘', href: '/js/oop' }
			]
		},
		{
			title: 'TypeScript',
			icon: 'ğŸ“˜',
			color: 'text-blue-600',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/ts/basics' },
				{ title: 'å‹ã®ç¨®é¡', href: '/ts/types' },
				{ title: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹', href: '/ts/interfaces' },
				{ title: 'ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹', href: '/ts/generics' }
			]
		},
		{
			title: 'Next.js',
			icon: 'â–²',
			color: 'text-gray-900 dark:text-white',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/nextjs/intro' },
				{ title: 'ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°', href: '/nextjs/routing' },
				{ title: 'ãƒ‡ãƒ¼ã‚¿å–å¾—', href: '/nextjs/data-fetching' },
				{ title: 'API Routes', href: '/nextjs/api-routes' }
			]
		},
		{
			title: 'SvelteKit',
			icon: 'ğŸ”¥',
			color: 'text-orange-600',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/sveltekit/intro' },
				{ title: 'Svelteã¨ã¯', href: '/sveltekit/svelte' },
				{ title: 'Viteã¨ã¯', href: '/sveltekit/vite' },
				{ title: 'Tailwindå°å…¥', href: '/sveltekit/setup' },
				{ title: 'ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°', href: '/sveltekit/routing' },
				{ title: 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', href: '/sveltekit/loading' },
				{ title: 'ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', href: '/sveltekit/forms' },
				{ title: 'Hooks', href: '/sveltekit/hooks' },
				{ title: 'çŠ¶æ…‹ç®¡ç†', href: '/sveltekit/state' },
				{ title: 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ', href: '/sveltekit/layouts' },
				{ title: 'APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', href: '/sveltekit/api' },
				{ title: 'Supabaseé€£æº', href: '/sveltekit/supabase' },
				{ title: 'D1é€£æº', href: '/sveltekit/d1' },
				{ title: 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒª', href: '/sveltekit/libraries' }
			]
		},
		{
			title: 'Tailwind CSS',
			icon: 'ğŸ’¨',
			color: 'text-cyan-500',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/tailwind/intro' },
				{ title: 'ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£', href: '/tailwind/utilities' },
				{ title: 'ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–', href: '/tailwind/responsive' },
				{ title: 'ãƒ¢ãƒ€ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ', href: '/tailwind/layouts' },
				{ title: 'ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º', href: '/tailwind/customize' }
			]
		},
		{
			title: 'Supabase',
			icon: 'âš¡',
			color: 'text-emerald-500',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/supabase/intro' },
				{ title: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', href: '/supabase/setup' },
				{ title: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ', href: '/supabase/database' },
				{ title: 'èªè¨¼', href: '/supabase/auth' },
				{ title: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸', href: '/supabase/storage' }
			]
		},
		{
			title: 'Cloudflare',
			icon: 'â˜ï¸',
			color: 'text-orange-500',
			items: [
				{ title: 'ã¯ã˜ã‚ã«', href: '/cloudflare/intro' },
				{ title: 'D1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', href: '/cloudflare/d1' },
				{ title: 'D1 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', href: '/cloudflare/d1-setup' },
				{ title: 'D1 SQLã®åŸºæœ¬', href: '/cloudflare/d1-sql' },
				{ title: 'D1 SvelteKité€£æº', href: '/cloudflare/d1-sveltekit' },
				{ title: 'R2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸', href: '/cloudflare/r2' },
				{ title: 'Pages ãƒ‡ãƒ—ãƒ­ã‚¤', href: '/cloudflare/pages' }
			]
		},
		{
			title: 'Linux',
			icon: 'ğŸ§',
			color: 'text-amber-600',
			items: [
				{ title: 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ', href: '/linux/folder-structure' },
				{ title: 'Windowsã‹ã‚‰ã®ç§»è¡Œ', href: '/linux/switch-from-windows' },
				{ title: '2025å¹´äººæ°—ã®OS', href: '/linux/popular-2025' },
				{ title: 'ãƒªãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°', href: '/linux/rebranding' }
			]
		},
		{
			title: 'ãƒ–ãƒ©ã‚¦ã‚¶',
			icon: 'ğŸŒ',
			color: 'text-blue-500',
			items: [
				{ title: 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ', href: '/browser/folder-structure' },
				{ title: 'äººæ°—ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹', href: '/browser/popular-opensource' },
				{ title: 'ãƒªãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°', href: '/browser/rebranding' }
			]
		},
		{
			title: 'é–‹ç™ºæ–¹æ³•',
			icon: 'ğŸ› ï¸',
			color: 'text-gray-600 dark:text-gray-400',
			items: [
				{ title: 'ç§ã®é–‹ç™ºãƒ•ãƒ­ãƒ¼', href: '/dev/my-workflow' },
				{ title: 'ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹', href: '/dev/best-practices' },
				{ title: 'å€‹äººé–‹ç™º SvelteKit+D1', href: '/dev/sveltekit-d1-practices' }
			]
		}
	];

	// å±•é–‹çŠ¶æ…‹ã‚’ç®¡ç†
	let expanded = $state({});

	function toggleSection(title) {
		expanded[title] = !expanded[title];
	}

	function isActive(href) {
		return $page.url.pathname === href;
	}

	function isSectionActive(items) {
		return items.some(item => $page.url.pathname.startsWith(item.href.split('/').slice(0, 2).join('/')));
	}
</script>

<nav class="p-2 sm:p-3 md:p-4">
	<ul class="space-y-0.5 sm:space-y-1">
		{#each menuItems as section}
			<li>
				<button
					onclick={() => toggleSection(section.title)}
					class="w-full flex items-center justify-between px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors
					{isSectionActive(section.items) ? 'bg-gray-100 dark:bg-gray-700' : ''}"
				>
					<span class="flex items-center gap-1.5 sm:gap-2 min-w-0">
						<span class={`${section.color} text-lg sm:text-base flex-shrink-0`}>{section.icon}</span>
						<span class="font-medium text-sm sm:text-base truncate">{section.title}</span>
					</span>
					<svg
						class="w-4 h-4 transition-transform flex-shrink-0 {expanded[section.title] ? 'rotate-180' : ''}"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
					</svg>
				</button>

				{#if expanded[section.title]}
					<ul class="mt-0.5 sm:mt-1 ml-3 sm:ml-4 space-y-0.5 sm:space-y-1">
						{#each section.items as item}
							<li>
								<a
									href={item.href}
									class="block px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg text-xs sm:text-sm transition-colors
									{isActive(item.href)
										? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 font-medium'
										: 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}"
								>
									{item.title}
								</a>
							</li>
						{/each}
					</ul>
				{/if}
			</li>
		{/each}
	</ul>
</nav>
